<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Instacart Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    {% include '_styles.html' %}
  </head>
  <body class="bg-light">
    <div class="container-fluid vh-100 py-3">
      <div class="row h-100">
        {# include shared sidebar in embed mode so buttons drive the AJAX viewer #}
        {% set embed = True %}
        {% include '_sidebar.html' %}

        <!-- Main content area: load visualizations into iframe -->
        <main class="col bg-light p-0 d-flex flex-column">
          <header class="bg-white border-bottom p-3">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Visualization Viewer</h5>
              <div>
                <small class="text-muted">Data-driven views — click a button to load a visualization.</small>
              </div>
            </div>
          </header>

          <section class="flex-grow-1 position-relative p-3">
            <div id="mainPane" class="h-100 overflow-auto d-flex align-items-start justify-content-center">
              <!-- AJAX-loaded visualization fragments will be injected here and centered -->
            </div>
          </section>
        </main>
      </div>
    </div>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.29.1.min.js"></script>
    <style>
      /* spinner overlay */
      #spinnerOverlay{position:absolute;inset:0;display:none;background:rgba(255,255,255,0.7);z-index:50;align-items:center;justify-content:center}
    </style>
    <script>
      // Show a loading spinner while fetching data
      function showSpinner(){
        let overlay = document.getElementById('spinnerOverlay');
        if(!overlay){
          const main = document.getElementById('mainPane');
          overlay = document.createElement('div');
          overlay.id = 'spinnerOverlay';
          overlay.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';
          main.style.position = 'relative';
          main.appendChild(overlay);
        }
        overlay.style.display = 'flex';
      }
      function hideSpinner(){
        const overlay = document.getElementById('spinnerOverlay');
        if(overlay) overlay.style.display = 'none';
      }

      // Render helpers for each question (Plotly + table)
      function renderTable(records){
        if(!records || records.length===0) return '<div class="text-muted">No data</div>';
        const cols = Object.keys(records[0]);
        // detect numeric columns by scanning first non-null value
          const numeric = {};
          for(const c of cols){
            numeric[c] = false;
            for(const r of records){
              const v = r[c];
              if(v === null || v === undefined || v === '') continue;
              if(!isNaN(Number(String(v).replace(/,/g, '')))) numeric[c] = true;
              break;
            }
          }
          const nf = new Intl.NumberFormat('en-US');
          function formatCell(col, raw){
            if(raw === null || raw === undefined) return '';
            const s = String(raw);
            // percent-like columns (e.g., reorder_rate) -> format as percent when value is between 0 and 1
            if(/rate|pct|percent|reorder/i.test(col)){
              const n = Number(s);
              if(!isNaN(n)){
                // if given as fraction (0-1), convert to percent
                if(Math.abs(n) <= 1) return (n*100).toFixed(1) + '%';
                // if already in 0-100 range, show with 1 decimal and percent sign
                return n.toFixed(1) + '%';
              }
              return s;
            }
            if(numeric[col]){
              const n = Number(String(raw).replace(/,/g, ''));
              if(!isNaN(n)) return nf.format(n);
            }
            return s;
          }

          let html = '<div class="table-responsive"><table class="table table-sm table-striped data-table"><thead><tr>' + cols.map(c=>`<th class="${numeric[c] ? 'num' : 'text'}">${c}</th>`).join('') + '</tr></thead><tbody>';
          for(const r of records){
            html += '<tr>' + cols.map(c=>{
              const val = r[c] ?? '';
              const cls = numeric[c] ? 'num' : 'text';
              return `<td class="${cls}">${formatCell(c, val)}</td>`;
            }).join('') + '</tr>';
          }
          html += '</tbody></table></div>';
        return html;
      }

      function renderQ1(json){
        // Q1: Customer loyalty and product performance
        // Display top products by repeat purchase rate, colored by department with legend and explanation.
        const container = document.getElementById('mainPane');
        container.innerHTML = '<div class="p-3 bg-white rounded shadow-sm"><h4>Q1 — Customer loyalty and product performance</h4><p class="text-muted">Which products and departments show the highest rates of repeat purchases? Bars are colored by department to highlight departmental performance.</p><div id="plot" style="height:55vh;"></div><div id="table" class="mt-3"></div></div>';
        const recs = json.records || [];
        if(!recs.length){ document.getElementById('table').innerHTML = renderTable([]); return; }
        // Use top 10 by reorder_rate
        const sorted = recs.slice().sort((a,b)=>parseFloat(b.reorder_rate)-parseFloat(a.reorder_rate)).slice(0,10);
        const y = sorted.map(r=>r.product_name).reverse();
        const x = sorted.map(r=>parseFloat(r.reorder_rate)).reverse();
        // Map departments to colors
        const deptList = Array.from(new Set(sorted.map(r=>r.department)));
        const palette = ['#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd','#8c564b','#e377c2','#7f7f7f','#bcbd22','#17becf'];
        const deptColor = {};
        deptList.forEach((d,i)=> deptColor[d]=palette[i % palette.length]);
        const colors = sorted.map(r=> deptColor[r.department] ).reverse();
        // Bar chart with per-bar colors
        const data = [{type:'bar', x:x, y:y, orientation:'h', marker:{color:colors}}];
        const layout = {margin:{l:260,r:180,t:40,b:80},title:'Top 10 products by repeat purchase rate (colored by department)'};
        Plotly.newPlot('plot', data, layout, {responsive:true});
        // Build legend manually using dummy traces
        const legendTraces = deptList.map((d,i)=>({name:d, x:[null], y:[null], marker:{color:deptColor[d]}, type:'scatter', mode:'markers'}));
        Plotly.addTraces('plot', legendTraces);
        document.getElementById('table').innerHTML = renderTable(recs);
      }

      function renderQ2(json){
        // Q2: Demand over time — day-of-week bar chart and hour-of-day line plot
        const container = document.getElementById('mainPane');
        container.innerHTML = '<div class="p-3 bg-white rounded shadow-sm"><h4>Q2 — Demand over time and staff scheduling</h4><p class="text-muted">Busiest times for orders by day of week and hour of day. Use these patterns for staff planning and operational efficiency.</p><div id="plot_day" style="height:35vh;"></div><div id="plot_hour" style="height:30vh;" class="mt-3"></div><div id="table" class="mt-3"></div></div>';
        const dayRecs = json.day_records || [];
        const hourRecs = json.hour_records || [];
        // Day chart
        const dayNames = dayRecs.map(r=>r.day_name);
        const dayVals = dayRecs.map(r=>Number(r.total_items));
        const colors = ["#4E79A7", "#F28E2B", "#E15759", "#76B7B2", "#59A14F", "#EDC948", "#B07AA1"];
        Plotly.newPlot('plot_day', [{x:dayNames, y:dayVals, type:'bar', marker:{color:colors}}], {title:'Ordering activity by day of week', margin:{t:40}} , {responsive:true});
        // Hour chart
        const hours = hourRecs.map(r=>Number(r.hour_of_day));
        const hourVals = hourRecs.map(r=>Number(r.total_items));
        Plotly.newPlot('plot_hour', [{x:hours, y:hourVals, type:'scatter', mode:'lines+markers', marker:{color:'#1f77b4'}}], {title:'Ordering activity by hour of day', xaxis:{dtick:1}}, {responsive:true});
        // Table: combine day and hour for reference
        const combined = [];
        for(const d of dayRecs) combined.push(Object.assign({}, d));
        for(const h of hourRecs) combined.push(Object.assign({}, h));
        document.getElementById('table').innerHTML = renderTable(combined);
      }

      function renderQ3(json){
        // Q3: Products that are purchased together (cross-selling)
        const container = document.getElementById('mainPane');
        container.innerHTML = '<div class="p-3 bg-white rounded shadow-sm"><h4>Q3 — Products that are purchased together</h4><p class="text-muted">Top product pairs frequently bought together. Use these preferences to design cross-selling and bundle opportunities.</p><div id="plot" style="height:60vh;"></div><div id="table" class="mt-3"></div></div>';
        const recs = json.records || [];
        const top = recs.slice(0,20);
        const pairs = top.map(r=> (r.product_A||'') + ' + ' + (r.product_B||''));
        const counts = top.map(r=>Number(r.times_bought_together)||0);
        const data = [{x:counts.reverse(), y:pairs.reverse(), type:'bar', orientation:'h', marker:{color:'#2ca02c'}}];
        const layout = {title:'Top product pairs bought together', margin:{l:300}};
        Plotly.newPlot('plot', data, layout, {responsive:true});
        document.getElementById('table').innerHTML = renderTable(recs);
      }

      function renderQ4(json){
        // Q4: Customer segments and repurchase behavior
        // Show reorder rate (bars) and number of customers (line) on secondary y-axis
        const container = document.getElementById('mainPane');
        container.innerHTML = '<div class="p-3 bg-white rounded shadow-sm"><h4>Q4 — Customer segments and repurchase behavior</h4><p class="text-muted">How repurchase behavior and inter-order time vary by customer segment. High-frequency customers often show higher reorder rates.</p><div id="plot" style="height:55vh;"></div><div id="table" class="mt-3"></div></div>';
        const recs = json.records || [];
        if(!recs.length){ document.getElementById('table').innerHTML = renderTable([]); return; }
        const segs = recs.map(r=>r.customer_segment);
        const rates = recs.map(r=>Number(r.avg_reorder_rate)||0);
        const nums = recs.map(r=>Number(r.num_customers)||0);
        const trace1 = {x:segs, y:rates, name:'Avg reorder rate', type:'bar', marker:{color:'#76b7b2'}, yaxis:'y1'};
        const trace2 = {x:segs, y:nums, name:'Number of customers', type:'scatter', mode:'lines+markers', marker:{color:'#1f77b4'}, yaxis:'y2'};
        const layout = {title:'Reorder rate and number of customers by segment', yaxis:{title:'Average reorder rate'}, yaxis2:{title:'Number of customers', overlaying:'y', side:'right'}};
        Plotly.newPlot('plot', [trace1, trace2], layout, {responsive:true});
        document.getElementById('table').innerHTML = renderTable(recs);
      }

      function renderQ5(json){
        const container = document.getElementById('mainPane');
        container.innerHTML = '<div id="table" class="mt-3"></div>';
        const recs = json.records;
        document.getElementById('table').innerHTML = renderTable(recs);
      }

      async function loadAndRender(url){
        showSpinner();
        try{
          const res = await fetch(url, {credentials:'same-origin'});
          if(!res.ok) throw new Error('Network');
          const json = await res.json();
          if(url.includes('/api/q1')) renderQ1(json);
          else if(url.includes('/api/q2')) renderQ2(json);
          else if(url.includes('/api/q3')) renderQ3(json);
          else if(url.includes('/api/q4')) renderQ4(json);
          else if(url.includes('/api/q5')) renderQ5(json);
          else document.getElementById('mainPane').innerHTML = '<div class="alert alert-warning">Unknown view</div>';
        }catch(err){
          console.error(err);
          document.getElementById('mainPane').innerHTML = '<div class="alert alert-danger">Failed to load data.</div>';
        }finally{ hideSpinner(); }
      }

      document.addEventListener('DOMContentLoaded', function(){
        const buttons = Array.from(document.querySelectorAll('.viz-btn'));
        function setActiveBySrc(src){
          buttons.forEach(b=>b.classList.remove('active'));
          const btn = buttons.find(b=>b.getAttribute('data-src')===src);
          if(btn) btn.classList.add('active');
        }
        buttons.forEach(btn => {
          // init tooltip
          new bootstrap.Tooltip(btn, {title: btn.getAttribute('data-bs-title')});
          btn.addEventListener('click', async function(){
            const src = btn.getAttribute('data-src');
            try{
              await loadAndRender(src);
              // push history state so back/forward works
              try{ history.pushState({view: src}, '', '?view=' + encodeURIComponent(src)); }catch(e){}
              setActiveBySrc(src);
            }catch(err){
              console.error(err);
              document.getElementById('mainPane').innerHTML = '<div class="alert alert-danger">Failed to load view.</div>';
            }
          });
        });

        // support loading a specific view via ?view= URL param
        const params = new URLSearchParams(window.location.search);
        const initialView = params.get('view');
        if(initialView){
          const match = buttons.find(b=>b.getAttribute('data-src')===initialView);
          if(match){ match.click(); }
          else { loadAndRender(initialView).then(()=>setActiveBySrc(initialView)).catch(()=>{}); }
        } else if(buttons.length){
          buttons[0].click();
        }

        // handle back/forward
        window.addEventListener('popstate', function(ev){
          const view = (ev.state && ev.state.view) || new URLSearchParams(window.location.search).get('view');
          if(view){
            loadAndRender(view).then(()=> setActiveBySrc(view)).catch(()=>{});
          }
        });
      });
    </script>
  </body>
</html>
